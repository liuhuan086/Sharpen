# CDN

## 什么是CDN？

CDN的全称是Content Delivery Network，即[内容分发网络](https://baike.baidu.com/item/内容分发网络/4034265)。CDN是构建在现有网络基础之上的智能虚拟网络，依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。CDN的关键技术主要有内容存储和分发技术。

但是在渗透测试中，若目标存在CDN服务，将会影响到后续的安全测试过程。因为我们测试的只是CDN结点，而不是源服务器（目标）。

![img](https://bkimg.cdn.bcebos.com/pic/4610b912c8fcc3ce005c05d19c45d688d53f20b0?x-bce-process=image/watermark,image_d2F0ZXIvYmFpa2U4MA==,g_7,xp_5,yp_5/format,f_auto)

## 如何判断CDN存在？

利用多结点技术进行请求返回判断。当某个根域名的二级域名的IP不同时（同网段，不同网段），可以猜测对方使用了CDN技术。

```
www.test.com	192.168.1.10
test.com		192.168.1.10
bbs.test.com	192.168.1.11~192.168.1.254
game.test.com   172.10.10.10
```

## 绕过CDN

- 子域名查询

- 邮件服务查询

    - 一般的邮件系统都在内部，没有经过CDN的解析，通过利用目标网站的邮箱注册、找回密码或者RSS订阅等功能，查看邮件、寻找邮件头中的邮件服务器域名IP，ping这个邮件服务器的域名,就可以获得目标的真实IP。

        注意：必须是目标自己的邮件服务器，第三方或公共邮件服务器是没有用的。

    - 通过邮件查询的结果，获取到IP地址，再借助第三方工具进行判断

        小技巧：**国内域名一般都会备案，查看到IP之后与备案地址核对，判断是否一致**。

- 国外地址请求

    - 针对特定的用户群体，建设特定的CDN，非特定群体，则可能没有提供CDN节点，因此，便可通过国外地址请求获取到目标地址

- 遗留文件

    ```
    inurl:phpinfo.php
    ```

- 全网扫描

    - 把所有的可能性都整合到一起。
    - 没有办法的办法，如果目标服务器在上海，那么在上海访问的时候，可能就是直接访问的目标服务器，而不是CDN节点。

- 黑暗引擎搜索特定文件

    - 某些文件可能没有同步到或者未在CDN上进行缓存，因此，如果访问CDN上不存在的文件，就会直接去访问目标服务器。
    - 计算某些文件的hash值，在shodan中进行查询，是否存在历史文件信息，以此来获取真实IP地址。

- dns历史记录，以量打量（流量耗尽攻击）（不推荐：违法）

    - 因为CDN需要购买流量，当流量用完之后，CDN则会失效，再访问的时候，就是目标IP地址。



## CDN解析配置问题

如果在进行CDN配置的时候，只配置了`www`的主机记录，而没有配置`*`的主机记录，那么通过www进行访问的时候，是通过CDN访问的，但如果访问域名的时候，没有加上www，那么极有可能就是直接访问的主站（目标服务器）地址。

![img](https://borinboy.oss-cn-shanghai.aliyuncs.com/huan/20210501223353.png)

通过访问www.xueersi.com和xueersi.com可以获得不同的IP信息，其中www就是经过CDN节点解析的，而另外一个则是直接访问的目标主机。